## 好大一个坑

发现音乐 -> 排行榜页面
这个页面用到了 v-for 嵌套
正确的数据是：

```
  大数组：[
    {
      id：1,
      name：'小明',
      小数组：[
        {
          age：18,
          sex：'男'
        }
      ]
    },
    {
      id：2,
      name：'小刚',
      小数组：[
        {
          age：17,
          sex：'男'
        }
      ]
    },
    {
      id：3,
      name：'小红',
      小数组：[
        {
          age：16,
          sex：'女'
        }
      ]
    },
  ]
  <!-- 这里大数组的每一项 里都有一个小数组 -->
  <!-- 渲染页面：v-for大数组，同时也要 v-for 小数组中的数据 -->
```

这里踩的坑：
我先发请求拿到了 大数组 中的数据（这个数据不包括 小数组），然后直接保存到了组件自身。
这时，页面已经呈现了遍历 大数组 渲染后的效果。但是完整页面上还要遍历这个 大数组 中每一项的 小数组。
然后我又发请求拿到了 大数组 中的 小数组，接着将小数组 保存到 大数组的每一项里。然后.......这个小数组中的数据就一直不渲染到页面
但是 组件身上的数据是没有错误的，该拿到的都拿到了，mounted 中请求完毕之后也都可以 得到完整的数据。
找啊找啊找 bug.....一下午......
我用 v-if 控制了一下这个 小数组 的 DOM 元素 的显示和隐藏，默认让他先隐藏，然后等到全部数据拿到之后我再让他显示，
结果 tmd 好了 小数组 的数据也渲染出来了。
但是这样写不太好，因为涉及到两个请求，我让这两个请求都请求成功后，再把所有数据保存到自身，结果页面就没有任何毛病了

总结：当遇到 v-for 嵌套时，一定一定要把所有完整的数据都拿到后再让页面渲染数据

## 待开发

搜索建议 ok
搜索详细页（单曲、歌手、专辑、视频、歌单）ok
专辑详细页 ok
歌手详细页 ok
视频详细页 ok
喜欢歌曲 ok
歌手收藏(ok) 专辑收藏(ok) 视频收藏(ok) mv 收藏(ok) 歌单收藏(ok)
可以给收藏按钮 添加节流(ok)
视频点赞 mv 点赞()

搜索详细页的单曲如果点击播放的话，是在当前播放列表中播放的歌曲索引后面加一首歌，
然后播放列表会增加。在播放列表换歌不会使刚才 播放搜索的单曲添加进来的一首歌消失，
但是如果重新在歌单详细页切换歌曲的话会使 播放搜索歌曲在播放列表中消失。
每次播放歌单页里面的歌曲会重新把这个歌单的 歌曲传给 播放列表，这就导致以上 bug（已修复）

footer 组件中我用 playlistId 记录每次传过来的播放列表，判断一下原来的 id 是否与传来的 id 相同。
如果相同的话就不修改播放列表，不同的话就说明点击了另一个歌单，则修改播放列表。
只要不修改播放列表，播放搜索的单曲在播放列表中就不消失

但是有些 tracks 不完整的歌单,每次播放歌曲都修改播放列表，不然的话如果下面的歌曲加载出来之后点击播放下面的歌曲，
它不会修改播放列表，播放列表里面没有播放的这首歌，就会导致一系列的错误。（真........）

bug： 搜索与播放列表相同的歌曲再次播放会清空 播放进度 （已修复）
判断播放列表有没有要播放的歌曲 id，有就不加一首歌进播放列表，直接定位到这首歌开始播放
没有，则加一首歌到播放列表当前播放歌曲的下面，然后开始播放。

bug：发现歌手 滚动到底没有数据后还会触发无限滚动事件 （已修复）
根据后台返回的 more 字段判断还有没有更多数据，more 为 true 则有更多数据，more 为 false 则没有更多数据
根据 more 来启用或者禁用无限滚动
所有的无限滚动都要一个停止无限滚动的逻辑判断，当后台数据都返回了就禁用无限滚动
无限滚动事件都要 async 请求的数据回来之前先让无限滚动的状态为禁用 await 请求 返回之后再启用无限滚动

bug： 发现排行榜首次加载时间太长（ 加了 v-loading ）

bug： 一个专辑里面都是没有权限的歌曲会一直 播放下一首 ( )

bug： 播放歌曲时要暂停视频或MV（已修复）

bug：搜索推荐 单曲能播放但报错（已修复）

bug： 专辑详情页，播放搜索建议歌曲会加到专辑歌曲列表里. 每日推荐列表也有这样的 bug(已修复)

究极 tm 小的细节啊！！！
由于 要改变播放列表 所以把新的播放列表保存在一个名为 newPlaylist 的对象中，传递给 Footer 组件改变播放列表
这里 newPlaylist 保存的是地址值！！！！然后传到 Footer 组件之后不能直接就把这个 newPlaylist（地址值）赋值给播放列表（this.playlist）
如果直接赋值给 this.playlist 的话 这不就是 两个值的地址值一样吗？！！！！ 播放列表(this.playlist) 和 newPlaylist(传来的播放列表)地址值一样
当某些行为要给播放列表里面添加歌曲的时候，地址值一样的话，那 newPlaylist 指向的对象中也会添加歌曲
因为这里操作 this.playlist 就等于操作了 newPlaylist 指向的对象。
所以解决办法就是拿到 newPlaylist 新的播放列表之后，深拷贝一份，然后再赋值给 this.playlist
这样 this.playlist 和 newPlaylist 的地址值就不一样了
要在播放列表(this.playlist)里面添加歌曲的话 newPlaylist 就不会受影响了

2022.9.19 收藏资源的小问题：
只有请求歌单详情 和 mv 详情 后台才会返回 是否已经收藏的字段
但是 视频 歌手 专辑 没有返回 是否已经收藏的字段

收藏了一个视频之后，获取这个视频详情，再取消收藏，再获取视频详情，两次获取的视频详情字段没有任何变化。
所以，后台没有返回 判断收没收藏的字段
解决：判断 vuex 仓库中有没有请求过收藏的资源，有就拿过来遍历判断当前这个资源是不是收藏的资源，没有就再发一遍请求。
拿到收藏的列表，然后再判断。

bug：卡片页面的 v-loading 还要优化（已解决）

喜欢/不喜欢 歌曲 事件加个节流 ( 已解决 )
喜欢歌曲还没有开发完 在 footer 页面中 有报错 （已解决）
思路：Footer 组件挂载后获取喜欢的歌曲 id 列表 判断当前播放的歌曲 id 是否为喜欢歌曲
每次向服务器发请求 喜欢歌曲 或 不喜欢歌曲 再让 Footer 重新获取一遍喜欢的歌曲 ID 列表

bug：播放搜索的单曲歌词不显示（ 已解决 ）
原因是 addSong 方法 添加一首歌到播放列表只添加到了 Footer 组件身上的 playlist 中，仓库中的播放列表没有新增的歌
添加到组件自身 playlist 的时候顺便仓库中的播放列表也添加一份就可以让卡片组件获取到了（卡片组件是映射的仓库中的 playlist 然后进行循环查找的）

bug：手动双击播放另一首歌曲的时候评论页数还是没有回到初始值 ( 已解决 )
每次仓库中的播放 playSongId 改变就回到初始值就可以了

bug：搜索详情页 视频 要先判断是视频还是 mv 再跳转
视频信息里的 type 如果是 0 就是 MV，如果是 1 就是视频。
这个可能是开发收藏--视频页解决一遍之后忘记写到这里了 ( 已解决 )

bug：歌单切换过快会出现歌单重合（ ）

还有视频、MV 点赞没有开发 ( )

bug：卡片组件按ESC关闭卡片但是，是在这个组件有焦点的情况下，如果点了footer组件就不能使用ESC关闭卡片了，只能在卡片上再次获取焦点后ESC才生效 (  )

播放音乐时要判断 video 里是否有 videoUrl 和 mvUrl 如果有就要 暂停视频或 MV
原来只判断了一个 videoUrl 没有判断 mvUrl，刚已经加上判断是否存在 mvUrl 的逻辑代码（ 已解决 ）

未登录 路由守卫。
未登录只能浏览发现音乐，只有登录了才能评论、收藏、添加喜欢音乐
未登录能： 发现音乐 歌单详情 专辑详情 歌手详情 搜索详情
未登录不能：收藏 点赞 评论/回复 添加喜欢 （ 有点问题/歌单回复评论 还是会发请求 ）

把未登录所有不能进的路径封装成一个数组

bug：未登录还会获取已收藏的资源问题 ( ok )
解决：在收藏仓库中已经添加未登录判断

bug：歌词滚动高亮还是有点问题（半解决）
这个 bug 可能是我开了 vue 开发者控制台监听数据的时候跟不上定时器的速度导致的，实际测试不开开发者控制台的话还是可以正常的滚动高亮的
  还有很多地方需要优化,可能以现在的能力有限，el-table数据太多会造成卡顿，然后定时器就都会不准!
关于这个定时器我感觉是我设置的触发间隔太短了10ms就触发一次，这样性能很差，不用确保歌词多么多么准确，至少要让它的高亮是正确的，我把定时器间隔设置成了200ms经过测试,这样好像会好一点,可以确实把时间拉长一点会好很多，就让歌词滚动定时器200ms吧，但是如果一个歌单很多歌曲(上千+)就会使el-table的DOM变得很多这样就还是会造成定时器不准，所以还是要优化一下el-table才比较完整.

最近好多天都在学英语，没太多时间来敲代码了。今天是2022-10-16 我把源码打包上传到GitHub